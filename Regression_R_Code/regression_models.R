require(ggplot2)
require(pscl) # for ZINB regression
require(MASS)
require(boot)
require(usdm) # for collinearity
require(plyr)
require(factoextra)
#install.packages("factoextra")
require(readr)

#define data
file = #set filepath
data_logit_smote=read.csv(file)

#define bank-size columns 
my_data <- data_logit[c(12:21)]

#preform PCA
prin_comp <- prcomp(my_data, scale. = T)
my_data.new_logit<-cbind(data_logit,prin_comp$x[,1:1])
colnames(my_data.new_logit)[colnames(my_data.new_logit)=="prin_comp$x[, 1:1]"] <- "banksize"

#PCA results
prin_comp$rotation
test<-princomp(my_data)
test$loadings


#Visualisations PCA
fviz_eig(prin_comp,  main = "" ) + theme(text = element_text(size = 20), axis.title = element_text(size = 20))
fviz_pca_biplot(prin_comp, invisible ="ind",col.var = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel=TRUE, title="") + theme(text = element_text(size = 20), axis.title = element_text(size = 20))


#Define Logistic Model

logit_model_banksize <- glm(is_targeted ~ banksize 
                            + has_parent + Rank2017  + 
                              + pop_score + auth1FA + auth2FA + Country_Austria + Country_Belgium + Country_Bulgaria + Country_Croatia+Country_Cyprus+Country_Czechia+
                              Country_Denmark+ Country_Estonia + Country_Finland+Country_France+Country_Germany+Country_Greece+Country_Hungary+Country_Ireland+Country_Italy+Country_Latvia+
                              Country_Lithuania+Country_Luxembourg+Country_Malta+Country_Netherlands+Country_Poland+Country_Portugal+Country_Romania +          
                              Country_Slovakia+Country_Slovenia+Country_Spain+Country_Sweden+ Country_United.Kingdom + langEnglish + langGerman 
                            + langFrench + langDutch + langItalian + langSpanish + langPortugese + langGreek +
                              langCzech + langSlovak + langSlovenian + langPolish + langHungarian +
                              langRomanian + langBulgarian + langDanish + langSwedish +
                              langFinnish + langLatvian + langEstonian + langLithuanian + lang_count,
                            data = my_data_logit, family = "binomial")
summary(logit_model_banksize)



#Evaluate performance of Logistic Model

#1. Deviance
cat('Difference between null and residual deviance: ',with(logit_model_banksize, null.deviance - deviance),'\r\n')
cat('Associated p-value (with chi^2 test; p-value < 0.001 means the model is significantly better):',with(logit_model_banksize,pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE)),'\r\n')

#2. McFadden R-square
logit_null = update(logit_model_banksize, . ~ 1)
cat('McFadden R-square:',1 - (logLik(logit_model_banksize)/logLik(logit_null)),'\r\n')

#3.accurancy assessment
logit_model_banksize.pred = rep('False',length(fitted(logit_model_banksize)))
logit_model_banksize.pred[fitted(logit_model_banksize)>0.5] = 'True'
table(logit_model_banksize.pred,data_logit_smote$is_targeted)
mean(logit_model_banksize.pred == data_logit_smote$is_targeted)

#4. AUC
library(ROCR)
pred <- prediction(fitted(logit_model_banksize), data_logit_smote$is_targeted)
perf <- performance(pred, measure = "tpr", x.measure = "fpr")
auc <- performance(pred, measure = "auc")
cat("AUC:")
auc@y.values
plot(perf, col=rainbow(10))


#STEPWISE Logistic Model

#only banksize
logit_model_1<- glm(is_targeted ~ Country_Austria + Country_Belgium + Country_Bulgaria + Country_Croatia+Country_Cyprus+Country_Czechia+
                      Country_Denmark+ Country_Estonia + Country_Finland+Country_France+Country_Germany+Country_Greece+Country_Hungary+Country_Ireland+Country_Italy+Country_Latvia+
                      Country_Lithuania+Country_Luxembourg+Country_Malta+Country_Netherlands+Country_Poland+Country_Portugal+Country_Romania +          
                      Country_Slovakia+Country_Slovenia+Country_Spain+Country_Sweden+ Country_United.Kingdom + lang_count+
                    
                      banksize, 
                    data = my_data_logit, family = "binomial")
summary(logit_model_1)

# banksize + authentication
logit_model_2<- glm(is_targeted ~ Country_Austria + Country_Belgium + Country_Bulgaria + Country_Croatia+Country_Cyprus+Country_Czechia+
                      Country_Denmark+ Country_Estonia + Country_Finland+Country_France+Country_Germany+Country_Greece+Country_Hungary+Country_Ireland+Country_Italy+Country_Latvia+
                      Country_Lithuania+Country_Luxembourg+Country_Malta+Country_Netherlands+Country_Poland+Country_Portugal+Country_Romania +          
                      Country_Slovakia+Country_Slovenia+Country_Spain+Country_Sweden+ Country_United.Kingdom + lang_count+
                      
                      banksize 
                    + auth2FA + auth1FA,
                    data = my_data_logit, family = "binomial")
summary(logit_model_2)

#banksize, authentication, language
logit_model_3<- glm(is_targeted ~ Country_Austria + Country_Belgium + Country_Bulgaria + Country_Croatia+Country_Cyprus+Country_Czechia+
                      Country_Denmark+ Country_Estonia + Country_Finland+Country_France+Country_Germany+Country_Greece+Country_Hungary+Country_Ireland+Country_Italy+Country_Latvia+
                      Country_Lithuania+Country_Luxembourg+Country_Malta+Country_Netherlands+Country_Poland+Country_Portugal+Country_Romania +          
                      Country_Slovakia+Country_Slovenia+Country_Spain+Country_Sweden+ Country_United.Kingdom + lang_count+
                      
                      banksize  
                    + auth2FA + auth1FA
                    + langEnglish + langGerman 
                    + langFrench + langDutch + langItalian + langSpanish + langPortugese + langGreek +
                      langCzech + langSlovak + langSlovenian + langPolish + langHungarian +
                      langRomanian + langBulgarian + langDanish + langSwedish +
                      langFinnish + langLatvian + langEstonian + langLithuanian,
                    data = my_data_logit, family = "binomial")
summary(logit_model_3)

#complete logistics model
logit_model<- glm(is_targeted ~ Country_Austria + Country_Belgium + Country_Bulgaria + Country_Croatia+Country_Cyprus+Country_Czechia+
                    Country_Denmark+ Country_Estonia + Country_Finland+Country_France+Country_Germany+Country_Greece+Country_Hungary+Country_Ireland+Country_Italy+Country_Latvia+
                    Country_Lithuania+Country_Luxembourg+Country_Malta+Country_Netherlands+Country_Poland+Country_Portugal+Country_Romania +          
                    Country_Slovakia+Country_Slovenia+Country_Spain+Country_Sweden+ Country_United.Kingdom + lang_count +
                    
                    banksize 
                  + auth1FA + auth2FA
                  + langEnglish + langGerman 
                  + langFrench + langDutch + langItalian + langSpanish + langPortugese + langGreek +
                    langCzech + langSlovak + langSlovenian + langPolish + langHungarian +
                    langRomanian + langBulgarian + langDanish + langSwedish +
                    langFinnish + langLatvian + langEstonian + langLithuanian
                  + pop_score+   has_parent + Rank2017 ,
                  data = my_data_logit, family = "binomial")
summary(logit_model)

# logistic regression without domain popularity - examining interaction domain popularity and banksize
logit_model_dom<- glm(is_targeted ~ Country_Austria + Country_Belgium + Country_Bulgaria + Country_Croatia+Country_Cyprus+Country_Czechia+
                        Country_Denmark+ Country_Estonia + Country_Finland+Country_France+Country_Germany+Country_Greece+Country_Hungary+Country_Ireland+Country_Italy+Country_Latvia+
                        Country_Lithuania+Country_Luxembourg+Country_Malta+Country_Netherlands+Country_Poland+Country_Portugal+Country_Romania +          
                        Country_Slovakia+Country_Slovenia+Country_Spain+Country_Sweden+ Country_United.Kingdom + lang_count +
                        
                        banksize  
                      + auth1FA + auth2FA
                      + langEnglish + langGerman 
                      + langFrench + langDutch + langItalian + langSpanish + langPortugese + langGreek +
                        langCzech + langSlovak + langSlovenian + langPolish + langHungarian +
                        langRomanian + langBulgarian + langDanish + langSwedish +
                        langFinnish + langLatvian + langEstonian + langLithuanian
                      +   has_parent + Rank2017 ,
                      data = my_data_logit, family = "binomial")
summary(logit_model_dom)


#1. Deviance performance stepwise models:
#model1
cat('Difference between null and residual deviance: ',with(logit_model_1, null.deviance - deviance),'\r\n')
cat('Associated p-value (with chi^2 test; p-value < 0.001 means the model is significantly better):',with(logit_model_1,pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE)),'\r\n')

#model2
cat('Difference between null and residual deviance: ',with(logit_model_2, null.deviance - deviance),'\r\n')
cat('Associated p-value (with chi^2 test; p-value < 0.001 means the model is significantly better):',with(logit_model_2,pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE)),'\r\n')

#model3
cat('Difference between null and residual deviance: ',with(logit_model_3, null.deviance - deviance),'\r\n')
cat('Associated p-value (with chi^2 test; p-value < 0.001 means the model is significantly better):',with(logit_model_3,pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE)),'\r\n')

#model4
cat('Difference between null and residual deviance: ',with(logit_model_dom, null.deviance - deviance),'\r\n')
cat('Associated p-value (with chi^2 test; p-value < 0.001 means the model is significantly better):',with(logit_model_3,pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE)),'\r\n')

#model5
cat('Difference between null and residual deviance: ',with(logit_model, null.deviance - deviance),'\r\n')
cat('Associated p-value (with chi^2 test; p-value < 0.001 means the model is significantly better):',with(logit_model_3,pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE)),'\r\n')

#2.McFadden R-square
logit_null = update(logit_model_1, . ~ 1)
cat('McFadden R-square:',1 - (logLik(logit_model_1)/logLik(logit_null)),'\r\n')

logit_null = update(logit_model_2, . ~ 1)
cat('McFadden R-square:',1 - (logLik(logit_model_2)/logLik(logit_null)),'\r\n')

logit_null = update(logit_model_3, . ~ 1)
cat('McFadden R-square:',1 - (logLik(logit_model_3)/logLik(logit_null)),'\r\n')

logit_null = update(logit_model_dom, . ~ 1)
cat('McFadden R-square:',1 - (logLik(logit_model_dom)/logLik(logit_null)),'\r\n')

logit_null = update(logit_model, . ~ 1)
cat('McFadden R-square:',1 - (logLik(logit_model)/logLik(logit_null)),'\r\n')

#3. Accurancy 
logit_model.pred = rep('False',length(fitted(logit_model_1)))
logit_model.pred[fitted(logit_model_1)>0.5] = 'True'
table(logit_model.pred,my_data_logit$is_targeted)
mean(logit_model.pred == my_data_logit$is_targeted)

logit_model.pred = rep('False',length(fitted(logit_model_2)))
logit_model.pred[fitted(logit_model_2)>0.5] = 'True'
table(logit_model.pred,my_data_logit$is_targeted)
mean(logit_model.pred == my_data_logit$is_targeted)

logit_model.pred = rep('False',length(fitted(logit_model_3)))
logit_model.pred[fitted(logit_model_3)>0.5] = 'True'
table(logit_model.pred,my_data_logit$is_targeted)
mean(logit_model.pred == my_data_logit$is_targeted)

logit_model.pred = rep('False',length(fitted(logit_model_dom)))
logit_model.pred[fitted(logit_model_dom)>0.5] = 'True'
table(logit_model.pred,my_data_logit$is_targeted)
mean(logit_model.pred == my_data_logit$is_targeted)

logit_model.pred = rep('False',length(fitted(logit_model)))
logit_model.pred[fitted(logit_model)>0.5] = 'True'
table(logit_model.pred,my_data_logit$is_targeted)
mean(logit_model.pred == my_data_logit$is_targeted)

#4. AUC-value
library(ROCR)
pred <- prediction(fitted(logit_model), my_data_logit$is_targeted)
perf <- performance(pred, measure = "tpr", x.measure = "fpr")
auc <- performance(pred, measure = "auc")
cat("AUC:")
auc@y.values

pred <- prediction(fitted(logit_model_1), my_data_logit$is_targeted)
perf <- performance(pred, measure = "tpr", x.measure = "fpr")
auc <- performance(pred, measure = "auc")
cat("AUC:")
auc@y.values
plot(perf, col=rainbow(10))

pred <- prediction(fitted(logit_model_2), my_data_logit$is_targeted)
perf <- performance(pred, measure = "tpr", x.measure = "fpr")
auc <- performance(pred, measure = "auc")
cat("AUC:")
auc@y.values
plot(perf, col=rainbow(10))

pred <- prediction(fitted(logit_model_3), my_data_logit$is_targeted)
perf <- performance(pred, measure = "tpr", x.measure = "fpr")
auc <- performance(pred, measure = "auc")
cat("AUC:")
auc@y.values
plot(perf, col=rainbow(10))

pred <- prediction(fitted(logit_model_dom), my_data_logit$is_targeted)
perf <- performance(pred, measure = "tpr", x.measure = "fpr")
auc <- performance(pred, measure = "auc")
cat("AUC:")
auc@y.values
plot(perf, col=rainbow(10))

pred <- prediction(fitted(logit_model), my_data_logit$is_targeted)
perf <- performance(pred, measure = "tpr", x.measure = "fpr")
auc <- performance(pred, measure = "auc")
cat("AUC:")
auc@y.values
plot(perf, col=rainbow(10))

#plot the results in a table
library(stargazer)
stargazer(logit_model_1,logit_model_2, logit_model_3, logit_model_dom, logit_model,
          type='text', title = "Summary of logistic model and negative binomial model towards different metrics",
          #dep.var.caption = ['Kit','Negative Binomial'],
          dep.var.labels=c('Kit', 'Rented', 'Private', 'All'),
          #covariate.labels = c('Number of hosted domains of shared IPs','Number of shared IPs hosting domains','MR1: Content security', 'MR2: Web-master security measures','MR3: Web infrastructure security','MR4: Web application security')
          notes = 'Standard errors in brackets', #omit=c('Country'),
          star.cutoffs = c(0.05, 0.01,0.001))


######################################
##### Negative Binomial Model  #######
######################################



#Total
file = #define file
data=read.csv(file)

#data 
data_notzero = data[(data$id_attack_count>0),]


data_notzero$X1<-NULL
#define banksize measures
my_data <- data_notzero[c(11:20)]
prin_comp <- prcomp(my_data, scale. = T)
my_data.new_nb<-cbind(data_notzero,prin_comp$x[,1:1])

colnames(my_data.new_nb)[colnames(my_data.new_nb)=="prin_comp$x[, 1:1]"] <- "banksize"

prin_comp$rotation
test<-princomp(my_data)
test$loadings

fviz_eig(prin_comp,  main = "" ) + theme(text = element_text(size = 20), axis.title = element_text(size = 20))

fviz_pca_biplot(prin_comp, invisible ="ind",col.var = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel=TRUE, title="") + theme(text = element_text(size = 20), axis.title = element_text(size = 20))





my_data.new_nb$year <- as.factor(my_data.new_nb$year)

nb_model_1<- glm.nb(id_attack_count ~ lang_count + country + threat_name + year + unique_attackurl_count +
                      
                      banksize,
                    data = my_data.new_nb)
summary(nb_model_1)

nb_model_2<- glm.nb(id_attack_count ~ lang_count + country + threat_name + year + unique_attackurl_count +
                      
                      
                      banksize + 
                      auth1FA +auth2FA,
                    data = my_data.new_nb)
summary(nb_model_2)


nb_model_3 <- glm.nb(id_attack_count ~ lang_count + country + threat_name + year + unique_attackurl_count +
                       
                       banksize +
                       auth1FA +auth2FA +
                       langEnglish + langGerman +
                       langFrench + langDutch + langItalian + langSpanish + langPortugese +
                       langGreek + langCzech +  langSlovenian + langPolish + langSlovak +langEstonian +
                       langHungarian + langRomanian + langBulgarian + langDanish +
                       langSwedish + langFinnish + langLatvian + 
                       langLithuanian ,
                     data = my_data.new_nb)
summary(nb_model_3)

nb_model_banksize <- glm.nb(id_attack_count ~ lang_count + country + threat_name + year + unique_attackurl_count +
                              
                              banksize +
                              auth1FA +auth2FA +
                              langEnglish + langGerman +
                              langFrench + langDutch + langItalian + langSpanish + langPortugese +
                              langGreek + langCzech +  langSlovenian + langPolish + langSlovak +langEstonian +
                              langHungarian + langRomanian + langBulgarian + langDanish +
                              langSwedish + langFinnish + langLatvian + 
                              langLithuanian +
                              pop_score + Rank2017 + has_parent,
                            data = my_data.new_nb)
summary(nb_model_banksize)

nb_model_lan <- glm.nb(id_attack_count ~ lang_count + country + threat_name + year + unique_attackurl_count +
                         
                         banksize +
                         auth1FA +(auth2FA*langSwedish) + (langHungarian*lang_count) + (langHungarian*langEnglish)+
                         langEnglish + langGerman +
                         (langFrench * langDutch) + ( langItalian *pop_score) + (langSpanish * langPortugese) +
                         langGreek + langCzech +  langSlovenian + (langPolish*pop_score) + langSlovak +langEstonian +
                         langHungarian + langRomanian + langBulgarian + langDanish +
                         langSwedish + langFinnish + langLatvian + 
                         langLithuanian +
                         pop_score + Rank2017 + has_parent,
                       data = my_data.new_nb)
summary(nb_model_lan)

nb_model_nolan <- glm.nb(id_attack_count ~ lang_count + country + threat_name + year + unique_attackurl_count +
                           
                           banksize +
                           auth1FA +auth2FA + 
                           pop_score + Rank2017 + has_parent,
                         data = my_data.new_nb)
summary(nb_model_nolan)


library(stargazer)
stargazer(nb_model_1, nb_model_2, nb_model_3, nb_model_banksize,
          type='latex', title = "Summary of logistic model and negative binomial model towards different metrics",
          #covariate.labels = c('Number of hosted domains of shared IPs','Number of shared IPs hosting domains','MR1: Content security', 'MR2: Web-master security measures','MR3: Web infrastructure security','MR4: Web application security')
          notes = 'Standard errors in brackets', #omit=c('Country'),
          star.cutoffs = c(0.05, 0.01,0.001))

library(stargazer)
stargazer(nb_model_banksize, nb_model_lan,
          type='latex', title = "Summary of logistic model and negative binomial model towards different metrics",
          #dep.var.caption = ['Kit','Negative Binomial'],
          #covariate.labels = c('Number of hosted domains of shared IPs','Number of shared IPs hosting domains','MR1: Content security', 'MR2: Web-master security measures','MR3: Web infrastructure security','MR4: Web application security')
          notes = 'Standard errors in brackets', #omit=c('Country'),
          star.cutoffs = c(0.05, 0.01,0.001))


#performance evaluation

#1. nb_model_1

cat('Difference between null and residual deviance: ',with(nb_model_1, null.deviance - deviance),'\r\n')
cat('Associated p-value (with chi^2 test; p-value < 0.001 means the model is significantly better):',with(nb_model_1,pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE)),'\r\n')

nb_null = update(nb_model_1, . ~ 1)
cat('McFadden R-square:',1 - (logLik(nb_model_1)/logLik(nb_null)),'\r\n')

hist(my_data.new_nb$id_attack_count,breaks=50)

# Check dispersion rate using Poisson Regression
poi_model <- glm(id_attack_count ~ lang_count + country + threat_name + year + unique_attackurl_count +
                   
                   banksize,
                 data = my_data.new_nb, family = quasipoisson())
summary(poi_model)

#2. nb_model_2

cat('Difference between null and residual deviance: ',with(nb_model_2, null.deviance - deviance),'\r\n')
cat('Associated p-value (with chi^2 test; p-value < 0.001 means the model is significantly better):',with(nb_model_2,pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE)),'\r\n')

nb_null = update(nb_model_2, . ~ 1)
cat('McFadden R-square:',1 - (logLik(nb_model_2)/logLik(nb_null)),'\r\n')

hist(my_data.new_nb$id_attack_count,breaks=50)

# Check dispersion rate using Poisson Regression
poi_model <- glm(id_attack_count ~ lang_count + country + threat_name + year + unique_attackurl_count +
                   
                   
                   banksize + 
                   auth1FA +auth2FA,
                 data = my_data.new_nb, family = quasipoisson())
summary(poi_model)

#3
cat('Difference between null and residual deviance: ',with(nb_model_3, null.deviance - deviance),'\r\n')
cat('Associated p-value (with chi^2 test; p-value < 0.001 means the model is significantly better):',with(nb_model_3,pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE)),'\r\n')


nb_null = update(nb_model_3, . ~ 1)
cat('McFadden R-square:',1 - (logLik(nb_model_3)/logLik(nb_null)),'\r\n')



poi_model <- glm(id_attack_count ~ lang_count + country + threat_name + year + unique_attackurl_count +
                   
                   banksize +
                   auth1FA +auth2FA +
                   langEnglish + langGerman +
                   langFrench + langDutch + langItalian + langSpanish + langPortugese +
                   langGreek + langCzech +  langSlovenian + langPolish + langSlovak +langEstonian +
                   langHungarian + langRomanian + langBulgarian + langDanish +
                   langSwedish + langFinnish + langLatvian + 
                   langLithuanian ,
                 data = my_data.new_nb, family = quasipoisson())
summary(poi_model)


#total
cat('Difference between null and residual deviance: ',with(nb_model_banksize, null.deviance - deviance),'\r\n')
cat('Associated p-value (with chi^2 test; p-value < 0.001 means the model is significantly better):',with(nb_model_banksize,pchisq(null.deviance - deviance, df.null - df.residual, lower.tail = FALSE)),'\r\n')


nb_null = update(nb_model_banksize, . ~ 1)
cat('McFadden R-square:',1 - (logLik(nb_model_banksize)/logLik(nb_null)),'\r\n')

poi_model <- glm(id_attack_count ~ lang_count + country + threat_name + year + unique_attackurl_count +
                   
                   banksize +
                   auth1FA +auth2FA +
                   langEnglish + langGerman +
                   langFrench + langDutch + langItalian + langSpanish + langPortugese +
                   langGreek + langCzech +  langSlovenian + langPolish + langSlovak +langEstonian +
                   langHungarian + langRomanian + langBulgarian + langDanish +
                   langSwedish + langFinnish + langLatvian + 
                   langLithuanian +
                   pop_score + Rank2017 + has_parent,
                 data = my_data.new_nb, family = quasipoisson())
summary(poi_model)


######################################
########### Literature  #############
######################################


logit_model_lit_all <- glm(is_targeted  ~ EmployeesOver500 + EmployeesUnder250 + RevenuesUnder31 ,
                           data=data_logit_smote,
                           family = "binomial")
summary(logit_model_lit_all) # model description





